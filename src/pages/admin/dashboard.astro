---
import ProductImage from '@/components/products/ProductImage.astro';
import Pagination from '@/components/shared/Pagination.astro';
import MainLayout from '@/layouts/MainLayout.astro';
import { actions } from 'astro:actions';

const searchParams = Astro.url.searchParams;
const pageParam = Number(searchParams.get('page')) ?? 1;

const {data, error} = await actions.getProductsByPage({
  page: pageParam,
});

if (error) {
  return Astro.redirect('/');
}

const { products, totalPages } = data;

---

<MainLayout title="Admin Dashboard">
  <h1>Admin Dashboard</h1>

  <p>Product list</p>
  <table class="w-full mt-2">
    <thead>
      <tr>
        <th class="border px-4 py-2">Image</th>
        <th class="border px-4 py-2">Title</th>
        <th class="border px-4 py-2">Price</th>
        <th class="border px-4 py-2">Stock</th>
      </tr>
    </thead>
    <tbody>
      {
        products.map((product) => (
          <tr>
            <td class="border px-4 py-2">
              <ProductImage src={product.images.split(',')[0] ?? ''} alt={product.title} className="w-16 h-16" />
            </td>
            <td class="border px-4 py-2">
              <a
                data-astro-prefetch="load"
                class="hover:underline cursor-pointer" 
                href={`/admin/products/${product.slug}`}
              >
                {product.title}
              </a>
            </td>
            <td class="border px-4 py-2">{product.price}</td>
            <td class="border px-4 py-2">{product.stock}</td>
          </tr>
        ))
      }
    </tbody>
  </table>

  <Pagination totalPages={totalPages} />
</MainLayout>

